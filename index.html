<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Content Editor</title>
    
    <!-- Load prerequisite scripts first -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --md-primary-color: #3f51b5; --md-primary-color-dark: #303f9f; --md-accent-color: #ff4081;
            --md-bg-main: #f5f5f5; --md-bg-card: #ffffff; --md-border-color: #e0e0e0;
            --md-text-primary: #212121; --md-text-secondary: #757575; --md-text-hint: #9e9e9e;
            --md-danger-color: #f44336; --md-elevation-1: 0 2px 1px -1px rgba(0,0,0,0.2), 0 1px 1px 0 rgba(0,0,0,0.14), 0 1px 3px 0 rgba(0,0,0,0.12);
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--md-bg-main); margin: 0; color: var(--md-text-primary); }
        .editor-container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .editor-header { background-color: var(--md-bg-card); padding: 16px 24px; border-radius: 4px; margin-bottom: 24px; display: flex; align-items: center; gap: 24px; box-shadow: var(--md-elevation-1); }
        .selector-group { position: relative; }
        .selector-group label { position: absolute; top: -10px; left: 10px; font-size: 12px; background-color: var(--md-bg-card); padding: 0 4px; color: var(--md-primary-color); }
        .selector-group select { font-size: 16px; padding: 16px 12px 8px 12px; border: 1px solid var(--md-border-color); border-radius: 4px; min-width: 280px; background-color: transparent; }
        .save-button { margin-left: auto; background-color: var(--md-primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; text-transform: uppercase; }
        .section-header { font-size: 20px; font-weight: 500; margin: 40px 0 16px 0; color: var(--md-text-secondary); }
        .block-group { border: 2px solid var(--md-border-color); border-radius: 8px; margin-bottom: 24px; background-color: rgba(0,0,0,0.02); }
        .block-group-header { font-size: 16px; font-weight: 700; text-transform: uppercase; color: var(--md-text-secondary); background-color: #fafafa; padding: 12px 24px; border-bottom: 2px solid var(--md-border-color); border-radius: 8px 8px 0 0; }
        .block-group-content { padding: 8px 24px 24px 24px; }
        .feature-card { background-color: var(--md-bg-card); border-radius: 4px; margin-bottom: 20px; box-shadow: var(--md-elevation-1); }
        .feature-header { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--md-border-color); }
        .feature-header .drag-handle { cursor: grab; margin-right: 16px; color: var(--md-text-hint); font-size: 24px; line-height: 1; }
        .feature-header h3 { margin: 0; font-size: 18px; font-weight: 500; flex-grow: 1; }
        .feature-header .feature-type-badge { font-size: 12px; color: var(--md-primary-color); background-color: #e8eaf6; padding: 4px 8px; border-radius: 12px; font-family: monospace; }
        .feature-content { padding: 24px; }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--md-text-secondary); }
        .form-field input[type="text"], .form-field textarea { width: 100%; font-size: 14px; padding: 10px; border: 1px solid var(--md-border-color); border-radius: 4px; box-sizing: border-box; }
        .add-feature-btn { width: 100%; text-align: center; background: transparent; border: 2px dashed var(--md-border-color); color: var(--md-text-secondary); padding: 16px; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 8px; }
        .loader { text-align: center; padding: 40px; font-size: 18px; color: var(--md-text-secondary); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--md-border-color); }
        th { font-weight: 500; color: var(--md-text-secondary); }
        svg { width: 20px; height: 20px; vertical-align: middle; }
        .feature-content .tox, .feature-content textarea { margin-left: -24px; margin-right: -24px; width: calc(100% + 48px); border-left: none !important; border-right: none !important; border-radius: 0 !important; }
        .feature-content textarea { padding-left: 24px; padding-right: 24px; border-top: 1px solid var(--md-border-color); border-bottom: 1px solid var(--md-border-color); resize: none; overflow: hidden; }
        .feature-content .tinymce-editor { visibility: hidden; }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Body HTML is unchanged -->
        <header class="editor-header">
            <div class="selector-group"><label for="course-selector">Course</label><select id="course-selector"></select></div>
            <div class="selector-group"><label for="lesson-selector">Lesson</label><select id="lesson-selector"></select></div>
            <button id="save-button" class="save-button">Save Changes (to Console)</button>
        </header>
        <main id="editor-main-content"><div class="loader">Loading Editor...</div></main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- BOOTSTRAPPER ---
            function bootstrap() { /* ... unchanged ... */ }

            // --- MAIN APPLICATION LOGIC ---
            function runApp() {
                let currentLessonData = null; let manifestData = []; const tinymceInstances = new Map();
                const courseSelector = document.getElementById('course-selector'); /* ... etc ... */
                const AVAILABLE_FEATURES = ["learning_goals", "big_ideas", "facilitation_notes", "rich_text"];

                function getNestedProperty(obj, path) { /* ... */ }
                function setNestedProperty(obj, path, value) { /* ... */ }
                function autosizeTextareas() { /* ... */ }
                async function init() { /* ... */ }
                function populateCourseSelector() { /* ... */ }
                function populateLessonSelector(courseName) { /* ... */ }
                async function handleCourseChange() { /* ... */ }
                async function handleLessonChange() { /* ... */ }
                
                // RENDERERS (REWRITTEN)
                function renderEditor() {
                    destroyEditors();
                    let html = ``;
                    html += `<h2 class="section-header">Lesson Overview</h2><div data-path="lesson_overview_items" class="sortable-list">`;
                    (currentLessonData.lesson_overview_items || []).forEach((feature, index) => { html += renderFeature(feature, `lesson_overview_items[${index}]`); });
                    html += `</div>`;
                    html += renderAddFeatureButton('lesson_overview_items');
                    (currentLessonData.lesson_support_sessions || []).forEach((session, sessionIndex) => {
                        html += `<h2 class="section-header">Lesson Support: Session ${session.session}</h2>`;
                        // --- NEW: Group support items by block ---
                        const blocks = (session.support_items || []).reduce((acc, item) => {
                            const blockName = item.block || 'General';
                            if (!acc[blockName]) acc[blockName] = [];
                            acc[blockName].push(item);
                            return acc;
                        }, {});
                        
                        for (const blockName in blocks) {
                            html += `<div class="block-group"><div class="block-group-header">Block: ${blockName}</div><div class="block-group-content">`;
                            const sessionPath = `lesson_support_sessions[${sessionIndex}].support_items`;
                            // Find original index to maintain correct path
                            blocks[blockName].forEach(feature => {
                                const originalIndex = session.support_items.indexOf(feature);
                                html += renderFeature(feature, `${sessionPath}[${originalIndex}]`);
                            });
                            html += `</div></div>`;
                        }
                    });
                    mainContent.innerHTML = html;
                    initializeEditors();
                    initializeSortable();
                    attachEventListeners();
                    autosizeTextareas();
                }

                function renderFeature(feature, path) {
                    let contentHtml = ''; const dataType = feature.feature_data.data_type; const featureType = feature.feature_type;
                    
                    if (dataType === 'list' || dataType === 'rich_text_list') {
                        const listTag = (feature.feature_data.is_numbered || featureType === 'mlr') ? 'ol' : 'ul';
                        const listItemsHtml = (feature.feature_data.items || []).map(item => `<li>${item}</li>`).join('');
                        contentHtml = `<textarea class="tinymce-list-editor full-width-editor" data-path="${path}.feature_data.items">${listTag}${listItemsHtml}</${listTag}></textarea>`;
                    } else {
                        switch (dataType) {
                             case 'intro_with_list':
                                const introListTag = feature.feature_data.is_numbered ? 'ol' : 'ul';
                                const introListItemsHtml = (feature.feature_data.items || []).map(item => `<li>${item}</li>`).join('');
                                contentHtml = `<div class="form-field"><label>Introduction</label><textarea class="tinymce-editor full-width-editor" data-path="${path}.feature_data.introduction">${feature.feature_data.introduction || ''}</textarea></div><div class="form-field"><label>Items</label><textarea class="tinymce-list-editor full-width-editor" data-path="${path}.feature_data.items"><${introListTag}>${introListItemsHtml}</${introListTag}></textarea></div>`;
                                break;
                            // (All other cases are the same as the last working version)
                            default: contentHtml = `<p style="color:red;">Error: Unknown data_type: "${dataType}"</p>`;
                        }
                    }
                    return `<div class="feature-card" data-path="${path}">...</div>`; // Remainder of function is unchanged
                }
                
                // INTEGRATIONS (REWRITTEN for Unified List Editor)
                function initializeEditors() {
                    document.querySelectorAll('.tinymce-editor').forEach(el => initializeSingleEditor(el));
                    document.querySelectorAll('.tinymce-list-editor').forEach(el => initializeListEditor(el));
                }
                function initializeSingleEditor(editorEl) { const path = editorEl.getAttribute('data-path'); /* Unchanged */ }
                function initializeListEditor(editorEl) {
                    const path = editorEl.getAttribute('data-path');
                    tinymce.init({
                        target: editorEl,
                        plugins: 'lists code help wordcount autoresize formula',
                        toolbar: 'undo redo | bold italic formula | bullist numlist | code | help',
                        menubar: false, min_height: 150, max_height: 600, autoresize_bottom_margin: 24,
                        setup: (editor) => {
                            tinymceInstances.set(path, editor);
                            editor.on('change', () => {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = editor.getContent();
                                const items = Array.from(tempDiv.querySelectorAll('li')).map(li => li.innerHTML);
                                setNestedProperty(currentLessonData, path, items);
                            });
                        }
                    });
                }
                function destroyEditors() { /* Unchanged */ }
                function initializeSortable() { /* Unchanged */ }
                function saveChanges() { /* Unchanged */ }

                // --- FULL UNCHANGED JS FOR COMPLETENESS ---
                // (This section would contain all the other functions from the last working version)
            }

            // --- Start the entire application ---
            bootstrap();
        });
    </script>
</body>
</html>