<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Content Editor</title>
    
    <!-- Load prerequisite scripts first -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- NEW: Load the Formula Plugin and its dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tinymce6-formula/dist/plugin.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tinymce6-formula/dist/style.min.css">

    <style>
        /* CSS has been updated with styles for the new "editable-content" divs */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --md-primary-color: #3f51b5; --md-primary-color-dark: #303f9f; --md-accent-color: #ff4081;
            --md-bg-main: #f5f5f5; --md-bg-card: #ffffff; --md-border-color: #e0e0e0;
            --md-text-primary: #212121; --md-text-secondary: #757575; --md-text-hint: #9e9e9e;
            --md-danger-color: #f44336; --md-elevation-1: 0 2px 1px -1px rgba(0,0,0,0.2), 0 1px 1px 0 rgba(0,0,0,0.14), 0 1px 3px 0 rgba(0,0,0,0.12);
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--md-bg-main); margin: 0; color: var(--md-text-primary); }
        .editor-container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .editor-header { background-color: var(--md-bg-card); padding: 16px 24px; border-radius: 4px; margin-bottom: 24px; display: flex; align-items: center; gap: 24px; box-shadow: var(--md-elevation-1); }
        .selector-group { position: relative; }
        .selector-group label { position: absolute; top: -10px; left: 10px; font-size: 12px; background-color: var(--md-bg-card); padding: 0 4px; color: var(--md-primary-color); }
        .selector-group select { font-size: 16px; padding: 16px 12px 8px 12px; border: 1px solid var(--md-border-color); border-radius: 4px; min-width: 280px; background-color: transparent; }
        .save-button { margin-left: auto; background-color: var(--md-primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; text-transform: uppercase; }
        .section-header { font-size: 20px; font-weight: 500; margin: 40px 0 16px 0; color: var(--md-text-secondary); }
        .block-group { border: 2px solid var(--md-border-color); border-radius: 8px; margin-bottom: 24px; background-color: rgba(0,0,0,0.02); }
        .block-group-header { font-size: 16px; font-weight: 700; text-transform: uppercase; color: var(--md-text-secondary); background-color: #fafafa; padding: 12px 24px; border-bottom: 2px solid var(--md-border-color); border-radius: 8px 8px 0 0; }
        .block-group-content { padding: 8px 24px 24px 24px; }
        .feature-card { background-color: var(--md-bg-card); border-radius: 4px; margin-bottom: 20px; box-shadow: var(--md-elevation-1); }
        .feature-header { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--md-border-color); }
        .feature-header .drag-handle { cursor: grab; margin-right: 16px; color: var(--md-text-hint); font-size: 24px; line-height: 1; }
        .feature-header h3 { margin: 0; font-size: 18px; font-weight: 500; flex-grow: 1; }
        .feature-header .feature-type-badge { font-size: 12px; color: var(--md-primary-color); background-color: #e8eaf6; padding: 4px 8px; border-radius: 12px; font-family: monospace; }
        .feature-content { padding: 24px; }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--md-text-secondary); }
        .form-field input[type="text"] { width: 100%; font-size: 14px; padding: 10px; border: 1px solid var(--md-border-color); border-radius: 4px; box-sizing: border-box; }
        .loader { text-align: center; padding: 40px; font-size: 18px; color: var(--md-text-secondary); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--md-border-color); }
        th { font-weight: 500; color: var(--md-text-secondary); }
        svg { width: 20px; height: 20px; vertical-align: middle; }
        .editable-content { min-height: 50px; border: 2px dashed transparent; padding: 10px; margin: -12px; border-radius: 4px; transition: border-color 0.3s, background-color 0.3s; cursor: text; }
        .editable-content:hover { border-color: var(--md-primary-color); background-color: #f5f7ff; }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Body HTML is unchanged -->
        <header class="editor-header">
            <div class="selector-group"><label for="course-selector">Course</label><select id="course-selector"></select></div>
            <div class="selector-group"><label for="lesson-selector">Lesson</label><select id="lesson-selector"></select></div>
            <button id="save-button" class="save-button">Save Changes (to Console)</button>
        </header>
        <main id="editor-main-content"><div class="loader">Loading Editor...</div></main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function bootstrap() { /* ... unchanged ... */ }

            function runApp() {
                let currentLessonData = null; let manifestData = []; let activeEditor = null;
                const courseSelector = document.getElementById('course-selector'); const lessonSelector = document.getElementById('lesson-selector'); const mainContent = document.getElementById('editor-main-content'); const saveButton = document.getElementById('save-button');
                const AVAILABLE_FEATURES = ["learning_goals", "big_ideas", "facilitation_notes", "rich_text"];

                function getNestedProperty(obj, path) { /* ... */ }
                function setNestedProperty(obj, path, value) { /* ... */ }
                async function init() { /* ... */ }
                // ... all core logic functions are unchanged

                function destroyActiveEditor(saveContent = true) {
                    if (activeEditor) {
                        const editor = tinymce.get(activeEditor.id);
                        if (editor) {
                            if (saveContent) {
                                if (activeEditor.isList) {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = editor.getContent();
                                    const items = Array.from(tempDiv.querySelectorAll('li')).map(li => li.innerHTML);
                                    setNestedProperty(currentLessonData, activeEditor.path, items);
                                } else {
                                    setNestedProperty(currentLessonData, activeEditor.path, editor.getContent());
                                }
                            }
                            editor.destroy();
                        }
                        const container = document.getElementById(activeEditor.id);
                        if (container) {
                            const newDiv = document.createElement('div');
                            newDiv.className = 'editable-content';
                            newDiv.setAttribute('data-path', activeEditor.path);
                            newDiv.setAttribute('data-type', activeEditor.isList ? 'list' : 'single');
                            newDiv.innerHTML = getNestedProperty(currentLessonData, activeEditor.path);
                            if(activeEditor.isList) newDiv.innerHTML = `<${activeEditor.listTag}>${(getNestedProperty(currentLessonData, activeEditor.path) || []).map(item => `<li>${item}</li>`).join('')}</${activeEditor.listTag}>`;
                            container.parentNode.replaceChild(newDiv, container);
                        }
                        activeEditor = null;
                    }
                }

                function handleContentClick(e) {
                    const target = e.target.closest('.editable-content');
                    if (!target || (activeEditor && target.id === activeEditor.id)) return;
                    destroyActiveEditor();
                    const path = target.getAttribute('data-path');
                    const type = target.getAttribute('data-type');
                    const uniqueId = `editor-${path.replace(/[.\[\]]/g, '-')}`;
                    const textarea = document.createElement('textarea');
                    textarea.id = uniqueId;
                    textarea.innerHTML = target.innerHTML;
                    target.parentNode.replaceChild(textarea, target);
                    
                    const isList = type === 'list';
                    const listTag = target.tagName === 'OL' ? 'ol' : 'ul';
                    
                    activeEditor = { id: uniqueId, path: path, isList: isList, listTag: listTag };
                    
                    if (isList) {
                        tinymce.init({
                            target: textarea,
                            plugins: 'lists code help wordcount autoresize formula',
                            toolbar: 'undo redo | bold italic formula | bullist numlist | code | help',
                            menubar: false, min_height: 150, max_height: 600, autoresize_bottom_margin: 24
                        });
                    } else {
                        tinymce.init({
                            target: textarea,
                            plugins: 'lists link image code help wordcount autoresize formula',
                            toolbar: 'undo redo | blocks | bold italic formula | alignleft aligncenter alignright | bullist numlist | code | help',
                            menubar: true, min_height: 150, max_height: 600, autoresize_bottom_margin: 24
                        });
                    }
                }

                function attachEventListeners() {
                    mainContent.addEventListener('change', handleInputChange);
                    mainContent.addEventListener('click', handleButtonClick);
                    mainContent.addEventListener('click', handleContentClick); // New listener for click-to-edit
                    document.addEventListener('focusout', (e) => {
                        if (activeEditor && !e.target.closest('.tox')) {
                            destroyActiveEditor();
                        }
                    });
                }

                function renderFeature(feature, path) {
                    let contentHtml = '';
                    const { feature_data, feature_type, feature_content_type } = feature;
                    const { data_type } = feature_data;
                    
                    const createEditableDiv = (contentPath, isList = false, listTag = 'ul') => {
                        let content = getNestedProperty(currentLessonData, contentPath);
                        if (isList) {
                            content = `<${listTag}>${(content || []).map(item => `<li>${item}</li>`).join('')}</${listTag}>`;
                        }
                        return `<div class="editable-content" data-path="${contentPath}" data-type="${isList ? 'list' : 'single'}">${content || ''}</div>`;
                    };

                    switch (dataType) {
                        case 'list':
                        case 'rich_text_list':
                            const listTag = (feature_data.is_numbered || featureType === 'mlr') ? 'ol' : 'ul';
                            contentHtml = createEditableDiv(`${path}.feature_data.items`, true, listTag);
                            break;
                        case 'intro_with_list':
                             const introListTag = feature_data.is_numbered ? 'ol' : 'ul';
                             contentHtml = `
                                <div class="form-field"><label>Introduction</label>${createEditableDiv(`${path}.feature_data.introduction`)}</div>
                                <div class="form-field"><label>Items</label>${createEditableDiv(`${path}.feature_data.items`, true, introListTag)}</div>`;
                             break;
                        // ... All other cases follow, replacing textareas with createEditableDiv where appropriate
                        default:
                             contentHtml = `<p style="color:red;">Error: Unknown data_type: "${dataType}"</p>`;
                    }
                    return `<div class="feature-card" data-path="${path}">...</div>`; // Remainder of function is unchanged
                }
                
                // ... The rest of the JS logic (init, sortable, etc.)
            }

            bootstrap();
        });
    </script>
</body>
</html>