<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Content Editor</title>
    
    <!-- Load prerequisite scripts first -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        /* CSS is unchanged */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --md-primary-color: #3f51b5; --md-primary-color-dark: #303f9f; --md-accent-color: #ff4081;
            --md-bg-main: #f5f5f5; --md-bg-card: #ffffff; --md-border-color: #e0e0e0;
            --md-text-primary: #212121; --md-text-secondary: #757575; --md-text-hint: #9e9e9e;
            --md-danger-color: #f44336; --md-elevation-1: 0 2px 1px -1px rgba(0,0,0,0.2), 0 1px 1px 0 rgba(0,0,0,0.14), 0 1px 3px 0 rgba(0,0,0,0.12);
            --md-elevation-2: 0 3px 1px -2px rgba(0,0,0,0.2), 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12);
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--md-bg-main); margin: 0; color: var(--md-text-primary); }
        .editor-container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .editor-header { background-color: var(--md-bg-card); padding: 16px 24px; border-radius: 4px; margin-bottom: 24px; display: flex; align-items: center; gap: 24px; box-shadow: var(--md-elevation-2); }
        .selector-group { position: relative; }
        .selector-group label { position: absolute; top: -10px; left: 10px; font-size: 12px; background-color: var(--md-bg-card); padding: 0 4px; color: var(--md-primary-color); }
        .selector-group select { font-size: 16px; padding: 16px 12px 8px 12px; border: 1px solid var(--md-border-color); border-radius: 4px; min-width: 280px; background-color: transparent; }
        .save-button { margin-left: auto; background-color: var(--md-primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; text-transform: uppercase; box-shadow: var(--md-elevation-1); transition: background-color 0.3s; }
        .save-button:hover { background-color: var(--md-primary-color-dark); }
        .section-header { font-size: 20px; font-weight: 500; margin: 40px 0 16px 0; color: var(--md-text-secondary); }
        .feature-card { background-color: var(--md-bg-card); border-radius: 4px; margin-bottom: 20px; box-shadow: var(--md-elevation-1); }
        .feature-header { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--md-border-color); }
        .feature-header .drag-handle { cursor: grab; margin-right: 16px; color: var(--md-text-hint); font-size: 24px; line-height: 1; }
        .feature-header h3 { margin: 0; font-size: 18px; font-weight: 500; flex-grow: 1; }
        .feature-header .feature-type-badge { font-size: 12px; color: var(--md-primary-color); background-color: #e8eaf6; padding: 4px 8px; border-radius: 12px; font-family: monospace; }
        .feature-controls button { background: none; border: none; cursor: pointer; color: var(--md-text-hint); padding: 4px; }
        .feature-controls .delete-btn:hover { color: var(--md-danger-color); }
        .feature-content { padding: 24px; }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--md-text-secondary); }
        .form-field input[type="text"], .form-field textarea { width: 100%; font-size: 14px; padding: 10px; border: 1px solid var(--md-border-color); border-radius: 4px; box-sizing: border-box; resize: vertical; }
        .form-field textarea { min-height: 60px; }
        .list-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .add-feature-btn { width: 100%; text-align: center; background: transparent; border: 2px dashed var(--md-border-color); color: var(--md-text-secondary); padding: 16px; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 8px; transition: all 0.3s; }
        .add-feature-btn:hover { background-color: #fafafa; border-color: var(--md-primary-color); color: var(--md-primary-color); }
        .loader { text-align: center; padding: 40px; font-size: 18px; color: var(--md-text-secondary); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--md-border-color); }
        th { font-weight: 500; color: var(--md-text-secondary); }
        svg { width: 20px; height: 20px; vertical-align: middle; }
        .feature-content .form-field .tox, .feature-content .list-item .tox { margin-left: -24px; margin-right: -24px; width: calc(100% + 48px); border-left: none !important; border-right: none !important; border-radius: 0 !important; }
        .feature-content .form-field textarea.tinymce-editor, .feature-content .list-item textarea.tinymce-editor { visibility: hidden; }
    </style>
</head>
<body>
    <div class="editor-container">
        <header class="editor-header">
            <div class="selector-group"><label for="course-selector">Course</label><select id="course-selector"></select></div>
            <div class="selector-group"><label for="lesson-selector">Lesson</label><select id="lesson-selector"></select></div>
            <button id="save-button" class="save-button">Save Changes (to Console)</button>
        </header>
        <main id="editor-main-content"><div class="loader">Loading Editor...</div></main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- The Main Application Logic ---
            const app = {
                currentLessonData: null,
                manifestData: [],
                tinymceInstances: new Map(),
                dom: {
                    courseSelector: document.getElementById('course-selector'),
                    lessonSelector: document.getElementById('lesson-selector'),
                    mainContent: document.getElementById('editor-main-content'),
                    saveButton: document.getElementById('save-button')
                },
                AVAILABLE_FEATURES: ["learning_goals", "big_ideas", "facilitation_notes", "rich_text"],

                // --- UTILITIES ---
                getNestedProperty(obj, path) { return path.split(/[.\[\]]+/).filter(Boolean).reduce((res, key) => (res !== null && res !== undefined) ? res[key] : res, obj); },
                setNestedProperty(obj, path, value) { const keys = path.split(/[.\[\]]+/).filter(Boolean); const lastKey = keys.pop(); const lastObj = keys.reduce((res, key) => res[key] = res[key] || {}, obj); lastObj[lastKey] = value; },

                // --- CORE LOGIC ---
                async init() { 
                    try {
                        const response = await fetch('manifest.json');
                        if (!response.ok) throw new Error("Manifest file not found.");
                        this.manifestData = await response.json();
                        this.populateCourseSelector();
                        this.dom.courseSelector.addEventListener('change', () => this.handleCourseChange());
                        this.dom.lessonSelector.addEventListener('change', () => this.handleLessonChange());
                        this.dom.saveButton.addEventListener('click', () => this.saveChanges());
                        await this.handleCourseChange();
                    } catch (error) {
                        this.dom.mainContent.innerHTML = `<div class="loader" style="color:red;">Error: Could not load manifest.json. ${error.message}</div>`;
                    }
                },

                populateCourseSelector() { this.manifestData.forEach(course => this.dom.courseSelector.add(new Option(course.courseName, course.courseName))); },
                populateLessonSelector(courseName) { this.dom.lessonSelector.innerHTML = ''; const course = this.manifestData.find(c => c.courseName === courseName); if (course && course.lessons.length > 0) { this.dom.lessonSelector.disabled = false; course.lessons.forEach(lesson => this.dom.lessonSelector.add(new Option(lesson.name, lesson.path))); } else { this.dom.lessonSelector.disabled = true; this.dom.lessonSelector.add(new Option('No lessons available', '')); } },
                async handleCourseChange() { this.populateLessonSelector(this.dom.courseSelector.value); await this.handleLessonChange(); },
                async handleLessonChange() {
                    const path = this.dom.lessonSelector.value;
                    if (!path) { this.dom.mainContent.innerHTML = `<div class="loader">Select a lesson to begin...</div>`; this.currentLessonData = null; return; }
                    this.dom.mainContent.innerHTML = `<div class="loader">Loading lesson...</div>`;
                    try {
                        const response = await fetch(path);
                        if (!response.ok) throw new Error(`Could not fetch lesson file at ${path}`);
                        this.currentLessonData = await response.json();
                        this.renderEditor();
                    } catch (error) {
                        this.dom.mainContent.innerHTML = `<div class="loader" style="color:red;">Error loading lesson: ${error.message}</div>`;
                    }
                },
                
                // --- DYNAMIC RENDERING ---
                renderEditor() {
                    this.destroyEditors();
                    let html = ``;
                    html += `<h2 class="section-header">Lesson Overview</h2><div data-path="lesson_overview_items" class="sortable-list">`;
                    (this.currentLessonData.lesson_overview_items || []).forEach((feature, index) => { html += this.renderFeature(feature, `lesson_overview_items[${index}]`); });
                    html += `</div>`;
                    html += this.renderAddFeatureButton('lesson_overview_items');
                    (this.currentLessonData.lesson_support_sessions || []).forEach((session, sessionIndex) => {
                        const sessionPath = `lesson_support_sessions[${sessionIndex}].support_items`;
                        html += `<h2 class="section-header">Lesson Support: Session ${session.session}</h2><div data-path="${sessionPath}" class="sortable-list">`;
                        (session.support_items || []).forEach((feature, featureIndex) => { html += this.renderFeature(feature, `${sessionPath}[${featureIndex}]`); });
                        html += `</div>`;
                        html += this.renderAddFeatureButton(sessionPath);
                    });
                    this.dom.mainContent.innerHTML = html;
                    this.initializeEditors();
                    this.initializeSortable();
                    this.attachEventListeners();
                },

                renderFeature(feature, path) { /* ... Unchanged ... */ return ''; }, // Placeholder for brevity
                renderAddFeatureButton(path) { return `<button class="add-feature-btn" data-path="${path}">+ Add Feature to Section</button>`; },
                
                // --- EVENT HANDLING ---
                attachEventListeners() { this.dom.mainContent.addEventListener('change', (e) => this.handleInputChange(e)); this.dom.mainContent.addEventListener('click', (e) => this.handleButtonClick(e)); },
                handleInputChange(e) { if (e.target.matches('[data-path]')) { this.setNestedProperty(this.currentLessonData, e.target.getAttribute('data-path'), e.target.value); } },
                handleButtonClick(e) { const target = e.target.closest('button'); if (!target) return; if (target.classList.contains('delete-btn')) { if (confirm('Are you sure you want to delete this feature?')) { const card = target.closest('.feature-card'); const path = card.getAttribute('data-path'); const parentPath = path.substring(0, path.lastIndexOf('[')); const index = parseInt(path.substring(path.lastIndexOf('[') + 1, path.lastIndexOf(']'))); let parentArray = this.getNestedProperty(this.currentLessonData, parentPath); parentArray.splice(index, 1); this.renderEditor(); } } else if (target.classList.contains('add-feature-btn')) { const path = target.getAttribute('data-path'); const newFeatureType = prompt(`Enter new feature type:\n${this.AVAILABLE_FEATURES.join(', ')}`, 'rich_text'); if(newFeatureType && this.AVAILABLE_FEATURES.includes(newFeatureType)) { let parentArray = this.getNestedProperty(this.currentLessonData, path); const newFeature = { feature_type: newFeatureType, feature_title: `New ${newFeatureType.replace(/_/g, ' ')}`, feature_data: { data_type: 'rich_text', content: '' } }; parentArray.push(newFeature); this.renderEditor(); } else if (newFeatureType) { alert('Invalid feature type.'); } } },
                
                // --- INTEGRATIONS ---
                initializeEditors() { const editors = document.querySelectorAll('.tinymce-editor'); editors.forEach(editorEl => { const path = editorEl.getAttribute('data-path'); tinymce.init({ target: editorEl, height: editorEl.rows > 2 ? 250 : 150, menubar: true, plugins: 'lists link image code help wordcount', toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | code | help', setup: (editor) => { this.tinymceInstances.set(path, editor); editor.on('change', () => { this.setNestedProperty(this.currentLessonData, path, editor.getContent()); }); } }); }); },
                destroyEditors() { this.tinymceInstances.forEach((editor) => editor.destroy()); this.tinymceInstances.clear(); },
                initializeSortable() { const lists = document.querySelectorAll('.sortable-list'); lists.forEach(listEl => { new Sortable(listEl, { handle: '.drag-handle', animation: 150, onEnd: (evt) => { const path = evt.target.getAttribute('data-path'); let parentArray = this.getNestedProperty(this.currentLessonData, path); const [movedItem] = parentArray.splice(evt.oldIndex, 1); parentArray.splice(evt.newIndex, 0, movedItem); this.renderEditor(); } }); }); },
                
                saveChanges() { console.log("--- SAVING CHANGES ---"); console.log(JSON.stringify(this.currentLessonData, null, 2)); alert("Lesson data saved to the browser console (Press F12 to view)."); }
            };

            // This is the full renderFeature function, which was too large to fit in the placeholder above
            app.renderFeature = function(feature, path) {
                let contentHtml = ''; const dataType = feature.feature_data.data_type; const featureType = feature.feature_type; const hasHtmlContent = feature.feature_content_type === 'html';
                const getInputOrEditor = (itemPath, content, rows = 2) => { if (hasHtmlContent) return `<textarea class="tinymce-editor" data-path="${itemPath}">${content || ''}</textarea>`; return `<textarea rows="${rows}" data-path="${itemPath}">${content || ''}</textarea>`; };
                switch (dataType) { case 'list': contentHtml = (feature.feature_data.items || []).map((item, i) => `<div class="list-item">${getInputOrEditor(`${path}.feature_data.items[${i}]`, item, 1)}</div>`).join(''); break; case 'rich_text': if (featureType === 'learning_prompt') { contentHtml = `<div class="form-field"><label>Prompt Question</label>${getInputOrEditor(`${path}.feature_data.prompt_question`, feature.feature_data.prompt_question, 3)}</div><div class="form-field"><label>Prompt Answer</label>${getInputOrEditor(`${path}.feature_data.prompt_answer`, feature.feature_data.prompt_answer, 4)}</div>`; } else { contentHtml = getInputOrEditor(`${path}.feature_data.content`, feature.feature_data.content, 4); } break; case 'intro_with_structured_list': contentHtml = `<div class="form-field"><label>Introduction</label>${getInputOrEditor(`${path}.feature_data.introduction`, feature.feature_data.introduction, 4)}</div><label>Items</label>${(feature.feature_data.items || []).map((item, i) => `<div class="structured-list-item"><div class="form-field"><label>Title</label><input type="text" value="${item.title}" data-path="${path}.feature_data.items[${i}].title" /></div><div class="form-field"><label>Description</label><textarea rows="3" data-path="${path}.feature_data.items[${i}].description">${item.description}</textarea></div></div>`).join('')}`; break; case 'titled_content_with_list': contentHtml = `<div class="form-field"><label>Title</label><input type="text" value="${feature.feature_data.title || ''}" data-path="${path}.feature_data.title"></div><div class="form-field"><label>Introduction & List</label>${getInputOrEditor(`${path}.feature_data.introduction`, feature.feature_data.introduction, 8)}</div>`; break; case 'session_list': contentHtml = `<table><thead><tr><th>Session</th><th>Block</th><th>Title</th><th>Strategies</th><th>Duration</th><th>Mode</th></tr></thead><tbody>`; contentHtml += (feature.feature_data.items || []).map(item => `<tr><td>${item.session}</td><td>${item.block}</td><td>${item.title}</td><td>${(item.instructional_strategies || []).join(', ')}</td><td>${item.duration_minutes} min</td><td>${item.mode}</td></tr>`).join(''); contentHtml += `</tbody></table>`; break; case 'detailed_activity_facilitation': const data = feature.feature_data; let promptHtml = ''; if (data.activate_prompt) { promptHtml = `<div class="structured-list-item"><div class="form-field"><label>Activate Prompt Title</label><input type="text" value="${data.activate_prompt.title}" data-path="${path}.feature_data.activate_prompt.title" /></div><div class="form-field"><label>Activate Prompt Text</label><textarea rows="3" data-path="${path}.feature_data.activate_prompt.prompt_text">${data.activate_prompt.prompt_text}</textarea></div></div>`; } contentHtml = `<div class="form-field"><label>Purpose</label><input type="text" value="${data.purpose || ''}" data-path="${path}.feature_data.purpose" /></div>${promptHtml}<div class="form-field"><label>Steps</label>${getInputOrEditor(`${path}.feature_data.steps`, Array.isArray(data.steps) ? data.steps.join('\n\n') : data.steps, 8)}</div>`; break; case 'differentiation_strategy': contentHtml = `<div class="form-field"><label>Title</label><input type="text" value="${feature.feature_data.title || ''}" data-path="${path}.feature_data.title" /></div><div class="form-field"><label>Subtitle</label>${getInputOrEditor(`${path}.feature_data.subtitle`, feature.feature_data.subtitle)}</div><div class="form-field"><label>Text</label>${getInputOrEditor(`${path}.feature_data.text`, feature.feature_data.text, 4)}</div>`; break; case 'ongoing_assessment': contentHtml = `<div class="form-field"><label>Introduction</label><input type="text" value="${feature.feature_data.introduction_text || ''}" data-path="${path}.feature_data.introduction_text" /></div><div class="form-field"><label>Questions</label>${(feature.feature_data.questions || []).map((q, i) => `<div class="list-item">${getInputOrEditor(`${path}.feature_data.questions[${i}]`, q, 1)}</div>`).join('')}</div><div class="form-field"><label>Notes</label>${(feature.feature_data.notes || []).map((n, i) => `<div class="list-item">${getInputOrEditor(`${path}.feature_data.notes[${i}]`, n, 1)}</div>`).join('')}</div>`; break; case 'question_set_list': contentHtml = (feature.feature_data.items || []).map((item, i) => `<div class="question-set-item"><div class="form-field"><label>Student Page #</label><input type="text" value="${item.student_page_number}" data-path="${path}.feature_data.items[${i}].student_page_number" /></div><div class="form-field"><label>Item #s</label><input type="text" value="${item.item_numbers}" data-path="${path}.feature_data.items[${i}].item_numbers" /></div><div class="form-field"><label>Question Type</label><input type="text" value="${item.question_type}" data-path="${path}.feature_data.items[${i}].question_type" /></div><div class="form-field"><label>Questions</label>${(item.questions || []).map((q, qi) => `<div class="list-item">${getInputOrEditor(`${path}.feature_data.items[${i}].questions[${qi}]`, q, 1)}</div>`).join('')}</div></div>`).join(''); break; default: contentHtml = `<p style="color:red;">Error: Unknown data_type: "${dataType}"</p><pre><code>${JSON.stringify(feature.feature_data, null, 2)}</code></pre>`; }
                return `<div class="feature-card" data-path="${path}"><div class="feature-header"><span class="drag-handle">☰</span><div class="form-field" style="flex-grow:1; margin:0;"><label style="font-size:10px; color:#999;">Feature Title</label><input type="text" value="${feature.feature_title}" data-path="${path}.feature_title" style="border:0; background:transparent; padding:0; font-size:16px; font-weight:500;" /></div><span class="feature-type-badge">${featureType}</span><div class="feature-controls"><button class="delete-btn" title="Delete Feature"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div></div><div class="feature-content">${contentHtml}</div></div>`;
            }

            // Start the main application
            app.init();
        }
        
        // Start the entire application by first loading TinyMCE, then running main().
        loadTinyMCE(main);
    });
    </script>
</body>
</html>